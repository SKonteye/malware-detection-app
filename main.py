import streamlit as st
from PIL import Image
import joblib
import pandas as pd
import numpy as np
import string
import nltk
from nltk.corpus import stopwords
import string
from nltk.stem.porter import PorterStemmer
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
import pefile

ps = PorterStemmer()

nltk.download('punkt')
nltk.download('stopwords')

def transform_text(text):
    text = text.lower()
    y = []
    # tokenization
    text = nltk.word_tokenize(text)
    for i in text:
        if i.isalnum():
            y.append(i)
    text = y[:]
    y.clear()
    # removing stopwords and punctuations
    for i in text:
        if i not in stopwords.words('english') and i not in string.punctuation:
            y.append(i)
    text = y[:]
    y.clear()

    # stemming applied on text
    for i in text:
        y.append(ps.stem(i))
    return y

# Load the model and vectorizer
tfidf = joblib.load(open('model.pkl/vectorizer.pkl', 'rb'))
model = joblib.load(open('model.pkl/malware_detector.pkl', 'rb'))

st.title("Malware Detection")

# content

st.image(Image.open('model.pkl/malware_image.jpeg'))

st.write("""
A malware detection model uses machine learning to identify and classify malicious software. It analyzes various features and patterns to determine if a file or program is malware or not.

The algorithm used to train the model is a k classifier.
""")

input_file = st.file_uploader("Upload an .exe file for malware detection")

if input_file is not None:
    # 1. Extract characteristics
    pe = pefile.PE(data=input_file.read())
    characteristics = {
        'MajorLinkerVersion': pe.OPTIONAL_HEADER.MajorLinkerVersion,
        'MajorImageVersion': pe.OPTIONAL_HEADER.MajorImageVersion,
        'MajorOperatingSystemVersion': pe.OPTIONAL_HEADER.MajorOperatingSystemVersion,
        'SizeOfStackReserve': pe.OPTIONAL_HEADER.SizeOfStackReserve,
        'NumberOfSections': pe.FILE_HEADER.NumberOfSections,
        'ResourceSize': pe.sections[0].SizeOfRawData,  # Assuming the first section contains resources
        'legitimate': 1  # Assuming all uploaded .exe files are legitimate
    }

    # 2. Convert characteristics to dataframe
    df = pd.DataFrame([characteristics])

    # 3. Preprocess
    df['transformed_text'] = df['text'].apply(transform_text)
    df['transformed_text'] = df['transformed_text'].apply(lambda x: ' '.join(x))
    transform_file = df['transformed_text'].values

    # 4. Vectorize
    vector_input = tfidf.transform(transform_file.astype('str')).toarray()
    vector_input = pd.DataFrame(vector_input, columns=tfidf.get_feature_names_out())

    # 5. Predict
    prediction = model.predict(vector_input)[0]

    # 6. Display
    if prediction == 1:
        st.header("Malware Detected")
    else:
        st.header("No Malware Detected")

c1, c2, c3 = st.columns(3)
with c1:
    st.info('**GitHub:[@anilremo23](https://github.com/anilremo23)**', icon="üß†")
with c2:
    st.info('**Kaggle:[@remoanil](https://www.kaggle.com/remoanil)**', icon="üíª")
with c3:
    st.info('**LinkedIn:[@AnilMamidwar](https://www.linkedin.com/in/anil-mamidwar-001b6418/)**', icon="üë®‚Äçüíº")
